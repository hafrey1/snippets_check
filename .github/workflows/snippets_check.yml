name: Cloudflare Snippets Check (Email + API Key)

on:
  schedule:
    - cron: '0 12 * * *'  # 每天中午12点执行
  workflow_dispatch:

jobs:
  check_snippets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq git

      - name: Generate Snippets Status
        env:
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: |
          echo "| Domain | Zone ID | Snippets Available | Max Snippets |" > snippets_status.md
          echo "|--------|---------|-----------------|--------------|" >> snippets_status.md

          PAGE=1
          PER_PAGE=50

          while :; do
            ZONES=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?per_page=$PER_PAGE&page=$PAGE" \
              -H "X-Auth-Email: $CF_API_EMAIL" \
              -H "X-Auth-Key: $CF_API_KEY" \
              -H "Content-Type: application/json")

            # 判断是否为空
            if [ "$(echo "$ZONES" | jq '.result == null')" = "true" ]; then
              echo "❌ No zones found or permission issue"
              exit 1
            fi

            COUNT=$(echo "$ZONES" | jq '.result | length')
            if [ "$COUNT" -eq 0 ]; then
              break
            fi

            echo "$ZONES" | jq -c '.result[] | {id: .id, name: .name}' | while read -r zone; do
              DOMAIN=$(echo "$zone" | jq -r '.name')
              ZONE_ID=$(echo "$zone" | jq -r '.id')

              RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/rulesets/capabilities" \
                -H "X-Auth-Email: $CF_API_EMAIL" \
                -H "X-Auth-Key: $CF_API_KEY" \
                -H "Content-Type: application/json")

              SNIPPETS_COUNT=$(echo "$RESPONSE" | jq -r '.result[] | select(.id=="rulesets.snippets_rule_max") | .value')

              if [ -n "$SNIPPETS_COUNT" ]; then
                AVAILABLE="✅"
              else
                AVAILABLE="❌"
                SNIPPETS_COUNT="-"
              fi

              echo "| $DOMAIN | $ZONE_ID | $AVAILABLE | $SNIPPETS_COUNT |" >> snippets_status.md
            done

            if [ "$COUNT" -lt "$PER_PAGE" ]; then
              break
            fi
            PAGE=$((PAGE + 1))
          done

      - name: Commit and Push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add snippets_status.md
          git commit -m "Update Cloudflare Snippets status [skip ci]" || echo "No changes to commit"
          git push
