name: Cloudflare Snippets Check (Parallel + Max Snippets)

on:
  schedule:
    - cron: '0 12 * * *'  # 每天中午12点执行
  workflow_dispatch:

jobs:
  check_snippets_parallel_max:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq git curl

      - name: Generate Snippets Status (Parallel Safe with Max + Domain Hidden)
        env:
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: |
          OUTPUT_FILE="snippets_status.md"
          echo "| Domain | Snippets Available | Max Snippets |" > $OUTPUT_FILE
          echo "|--------|--------------------|--------------|" >> $OUTPUT_FILE

          PAGE=1
          PER_PAGE=50
          TEMP_DIR=$(mktemp -d)

          # 半隐藏域名函数
          hide_domain() {
            local domain="$1"
            local name="${domain%%.*}"    # 提取主域名
            local tld="${domain#*.}"      # 提取后缀
            local len=${#name}
            if [ $len -le 2 ]; then
              echo "$name***.$tld"
            else
              local half_len=$((len/2))
              echo "${name:0:half_len}****.$tld"
            fi
          }

          while :; do
            ZONES=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?per_page=$PER_PAGE&page=$PAGE" \
              -H "X-Auth-Email: $CF_API_EMAIL" \
              -H "X-Auth-Key: $CF_API_KEY" \
              -H "Content-Type: application/json")

            SUCCESS=$(echo "$ZONES" | jq -r '.success')
            if [ "$SUCCESS" != "true" ]; then
              echo "❌ API call failed"
              echo "$ZONES" | jq
              exit 1
            fi

            ZONES_ARRAY=$(echo "$ZONES" | jq -c '.result // empty | .[] | {id: .id, name: .name}')
            if [ -z "$ZONES_ARRAY" ]; then
              echo "⚠️ No zones found on this page"
              break
            fi

            for zone in $ZONES_ARRAY; do
              (
                DOMAIN=$(echo "$zone" | jq -r '.name')
                ZONE_ID=$(echo "$zone" | jq -r '.id')

                RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/rulesets/capabilities" \
                  -H "X-Auth-Email: $CF_API_EMAIL" \
                  -H "X-Auth-Key: $CF_API_KEY" \
                  -H "Content-Type: application/json")

                SNIPPETS_COUNT=$(echo "$RESPONSE" | jq -r '.result[]? | select(.id=="rulesets.snippets_rule_max") | .value')
                if [ -z "$SNIPPETS_COUNT" ] || [ "$SNIPPETS_COUNT" == "null" ]; then
                  SNIPPETS_COUNT="Unlimited"
                  AVAILABLE="✅"
                else
                  AVAILABLE="✅"
                fi

                SAFE_DOMAIN=$(echo "$DOMAIN" | sed 's/[^a-zA-Z0-9]/_/g')
                TMP_FILE=$(mktemp "$TEMP_DIR/${SAFE_DOMAIN}_XXXX.md")
                HIDDEN_DOMAIN=$(hide_domain "$DOMAIN")
                echo "| $HIDDEN_DOMAIN | $AVAILABLE | $SNIPPETS_COUNT |" > "$TMP_FILE"
              ) &
            done
            wait

            if compgen -G "$TEMP_DIR/*.md" > /dev/null; then
              cat "$TEMP_DIR"/*.md >> $OUTPUT_FILE
              rm -f "$TEMP_DIR"/*.md
            fi

            RESULT_COUNT=$(echo "$ZONES" | jq '.result | length')
            if [ "$RESULT_COUNT" -lt "$PER_PAGE" ]; then break; fi
            PAGE=$((PAGE + 1))
          done

      - name: Commit and Push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git add snippets_status.md
          git commit -m "Update Cloudflare Snippets status [parallel max] [skip ci]" || echo "No changes to commit"
          git push origin HEAD
