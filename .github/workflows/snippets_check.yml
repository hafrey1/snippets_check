- name: Generate Snippets Status (Parallel Safe with Max)
  env:
    CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
    CF_API_KEY: ${{ secrets.CF_API_KEY }}
  run: |
    OUTPUT_FILE="snippets_status.md"
    echo "| Domain | Zone ID | Snippets Available | Max Snippets |" > $OUTPUT_FILE
    echo "|--------|---------|-----------------|--------------|" >> $OUTPUT_FILE

    PAGE=1
    PER_PAGE=50
    TEMP_DIR=$(mktemp -d)

    while :; do
      ZONES=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?per_page=$PER_PAGE&page=$PAGE" \
        -H "X-Auth-Email: $CF_API_EMAIL" \
        -H "X-Auth-Key: $CF_API_KEY" \
        -H "Content-Type: application/json")

      SUCCESS=$(echo "$ZONES" | jq -r '.success')
      if [ "$SUCCESS" != "true" ]; then
        echo "❌ API call failed"
        exit 1
      fi

      ZONES_ARRAY=$(echo "$ZONES" | jq -c '.result // empty | .[] | {id: .id, name: .name}')
      if [ -z "$ZONES_ARRAY" ]; then break; fi

      for zone in $ZONES_ARRAY; do
        (
          DOMAIN=$(echo "$zone" | jq -r '.name')
          ZONE_ID=$(echo "$zone" | jq -r '.id')

          RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/rulesets/capabilities" \
            -H "X-Auth-Email: $CF_API_EMAIL" \
            -H "X-Auth-Key: $CF_API_KEY" \
            -H "Content-Type: application/json")

          # 获取 Max Snippets，API为空则显示 Unlimited
          SNIPPETS_COUNT=$(echo "$RESPONSE" | jq -r '.result[]? | select(.id=="rulesets.snippets_rule_max") | .value')
          if [ -z "$SNIPPETS_COUNT" ] || [ "$SNIPPETS_COUNT" == "null" ]; then
            SNIPPETS_COUNT="Unlimited"
            AVAILABLE="✅"
          else
            AVAILABLE="✅"
          fi

          TMP_FILE=$(mktemp "$TEMP_DIR/${ZONE_ID}_XXXX.md")
          echo "| $DOMAIN | $ZONE_ID | $AVAILABLE | $SNIPPETS_COUNT |" > "$TMP_FILE"
        ) &
      done
      wait

      if compgen -G "$TEMP_DIR/*.md" > /dev/null; then
        cat "$TEMP_DIR"/*.md >> $OUTPUT_FILE
        rm -f "$TEMP_DIR"/*.md
      fi

      RESULT_COUNT=$(echo "$ZONES" | jq '.result | length')
      if [ "$RESULT_COUNT" -lt "$PER_PAGE" ]; then break; fi
      PAGE=$((PAGE + 1))
    done
